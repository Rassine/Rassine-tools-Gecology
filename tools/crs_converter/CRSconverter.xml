<tool id='crs_converter' name='CRSconverter' version='1.0.0+galaxy@VERSION_SUFFIX@' profile='21.05'>
    <description>to modify Coordinate Reference Systems from a shapefile</description>
    <macros>
        <token name='@VERSION_SUFFIX@'>0</token>
        <import>CRS_macros.xml</import>
    </macros>
    <requirements> 
        <requirement type='package' version='4.3.3'>r-base</requirement> 
        <requirement type='package' version='1.0-16'>r-sf</requirement>
        <requirement type='package' version='1.3.1'>r-tidyr</requirement>
    </requirements>
    <command detect_errors='exit_code'><![CDATA[

        Rscript
            '$__tool_directory__/CRSconverter.R'
            ${os.path.join($input_file.extra_files_path, 'shapefile.shp')}
            ${output_file_format}
            #for $param_name in $input_param.keys() ## this loop successively calls all the names and values of the PROJ string for each option of the conditional, it avoids a 100 lines command.
                #if $param_name!='__current_case__'
                    #if $param_name=='south' and $input_param[$param_name]=='false'
                        #pass
                    #elif $param_name=='south' and $input_param[$param_name]=='true'
                        ' ' '+' $param_name
                    #elif $param_name=='approx' and $input_param[$param_name]=='false'
                        #pass
                    #elif $param_name=='approx' and $input_param[$param_name]=='true'
                        ' ' '+' $param_name
                    #elif $param_name=='lat_ts' and $input_param[$param_name]=='0'
                        #pass
                    #else
                        ' ' '+' $param_name '='
                        $input_param[$param_name]
                    #end if
                #end if
            #end for
            #if $output_file_format and 'shp' in $output_file_format
                &&
                mkdir ${shapefile.extra_files_path} &&
                mv shapefile.* ${shapefile.extra_files_path}
            #end if

         ]]></command>
    <inputs>
        <param name='input_file' type='data' format='shp'
               label='Input Format' help='Provide geospatial data in shapefile format (shp). To upload a shapefile on Galaxy : Click on "..." (Browse or update dataset) or "Upload File" on the side bar > Upload > Composite > composite type : shp > upload the available files of your dataset > start > close '/>
        <param name ='output_file_format' type='select' checked='true' multiple='true' optional='false'
               label='Output Format' help='Choose the file format in witch the tool output will be, multiple formats can be selected for multiple outputs, default output format is a shapefile.'>
            <option value='shp' selected='true'>shp</option>
            <option value='pdf'>pdf</option>
            <option value='png'>png</option>
            <option value='jpeg'>jpeg</option>
            <option value='tiff'>tiff</option>
            <option value='bmp'>bmp</option>
        </param>
        <conditional name='input_param'>
            <param name ='proj' type='select'
                   label='Projection ' help='Choose the projection in witch converting your geospatial data, see https://proj.org/en/9.4/operations/projections/index.html for more informations.'>
                <option value='adams_ws2'>[Miscellaneous] Adams World in a Square II (adams_ws2)</option>
                <option value='aeqd'>[Azimuthal] Azimuthal Equidistant (aeqd)</option>
                <option value='laea' selected='true'>[Azimuthal] Lambert Azimuthal Equal Area (laea)</option>
                <option value='aea'>[Conic] Albers Equal Area (aea)</option>
                <option value='eqdc'>[Conic] Equidistant Conic(eqdc)</option>
                <option value='natearth2'>[Pseudo cylindrical] Natural Earth II (natearth2)</option>
                <option value='webmerc'>[Cylindrical] Web Mercator (webmerc)</option>
                <option value='cea'>[Cylindrical] Cylindrical Equal Area (cea)</option>
                <option value='tcea'>[Cylindrical] Transverse Cylindrical Equal Area (tcea)</option>
                <option value='utm'>[Transverse cylindrical, conformal] Universal Transverse Mercator (UTM)</option>
                <option value='som'>[Conformal] Space Oblique Mercator (SOM)</option>
                <option value='eqc'>[Conformal cylindrical] Equidistant Cylindrical (eqc)</option>
            </param>
            <when value='adams_ws2'>
                <expand macro='ellps_options'/>
                <expand macro='longitude_options'/>
                <expand macro='X_options'/>
                <expand macro='Y_options'/>
                <expand macro='units_options'/>
            </when>
            <when value='aeqd'>
                <expand macro='ellps_options'/>
                <expand macro='latitude_options'/>
                <expand macro='longitude_options'/>
                <expand macro='X_options'/>
                <expand macro='Y_options'/>
                <expand macro='units_options'/>
            </when> 
            <when value='laea'>
                <expand macro='ellps_options'/>
                <expand macro='latitude_options'/>
                <expand macro='longitude_options'/>
                <expand macro='X_options'/>
                <expand macro='Y_options'/>
                <expand macro='units_options'/>
            </when>
            <when value='aea'>
                <expand macro='ellps_options'/>
                <expand macro='latitude_1_options'/>
                <expand macro='latitude_2_options'/>
                <expand macro='longitude_options'/>
                <expand macro='X_options'/>
                <expand macro='Y_options'/>
                <expand macro='units_options'/>
            </when>
            <when value='eqdc'>
                <expand macro='ellps_options'/>
                <expand macro='latitude_1_options'/>
                <expand macro='latitude_2_options'/>
                <expand macro='longitude_options'/>
                <expand macro='X_options'/>
                <expand macro='Y_options'/>
                <expand macro='units_options'/>
            </when>
            <when value='natearth2'>
                <expand macro='ellps_options'/>
                <expand macro='longitude_options'/>
                <expand macro='X_options'/>
                <expand macro='Y_options'/>
                <expand macro='units_options'/>
            </when>
            <when value='webmerc'>
                <expand macro='ellps_options'/>
                <expand macro='longitude_options'/>
                <expand macro='X_options'/>
                <expand macro='Y_options'/>
                <expand macro='units_options'/>
            </when>
            <when value='cea'>
                <expand macro='ellps_options'/>
                <expand macro='latitude_ts_options'/>
                <expand macro='K_options'/>
                <expand macro='longitude_options'/>
                <expand macro='X_options'/>
                <expand macro='Y_options'/>
                <expand macro='units_options'/>
            </when>
            <when value='tcea'>
                <expand macro='ellps_options'/>
                <expand macro='K_options'/>
                <expand macro='longitude_options'/>
                <expand macro='X_options'/>
                <expand macro='Y_options'/>
                <expand macro='units_options'/>
            </when>
            <when value='utm'>
                <expand macro='zone_options'/>
                <expand macro='ellps_options'/>
                <expand macro='south_options'/>
                <expand macro='algo_options'/>
                <expand macro='approx_options'/>
                <expand macro='units_options'/>
            </when>
            <when value='som'>
                <expand macro='asc_lon_options'/>
                <expand macro='inc_angle_options'/>
                <expand macro='ps_rev_options'/>
                <expand macro='ellps_options'/>
                <expand macro='longitude_options'/>
                <expand macro='X_options'/>
                <expand macro='Y_options'/>
                <expand macro='units_options'/>
            </when>
            <when value='eqc'>
                <expand macro='ellps_options'/>
                <expand macro='latitude_options'/>
                <expand macro='latitude_ts_options'/>
                <expand macro='longitude_options'/>
                <expand macro='X_options'/>
                <expand macro='Y_options'/>
                <expand macro='units_options'/>
            </when>
        </conditional>
    </inputs>
    <outputs>
        <data name='PDF_output' format='pdf' from_work_dir='PDF_output.pdf' 
             label='PDF output'>
            <filter>output_file_format and 'pdf' in output_file_format</filter>
        </data>
        <data name='png_output' format='png' from_work_dir='png_output.png'
             label='PNG output'>
            <filter>output_file_format and 'png' in output_file_format</filter>
        </data>
        <data name='jpeg_output' format='jpg' from_work_dir='jpeg_output.jpeg'
             label='JPEG output'>
            <filter>output_file_format and 'jpeg' in output_file_format</filter>
        </data>
        <data name='tiff_output' format='tiff' from_work_dir='tiff_output.tiff'
             label='TIFF output'>
            <filter>output_file_format and 'tiff' in output_file_format</filter>
        </data>
        <data name='bmp_output' format='bmp' from_work_dir='bmp_output.bmp'
             label='BMP output'>
            <filter>output_file_format and 'bmp' in output_file_format</filter>
        </data>
        <data name='shapefile' format='shp' from_work_dir='shapefile' label='Shapefile dataset'>
            <filter>output_file_format and 'shp' in output_file_format</filter>
        </data>
    </outputs>
    <tests>
        <test expect_num_outputs='6'>
            <param name='input_file' value='shapefiles/grid_aq_3_PF.html' ftype='shp'>
                <composite_data value='shapefiles/grid_aq_3_PF.shp'/>
                <composite_data value='shapefiles/grid_aq_3_PF.shx'/>
                <composite_data value='shapefiles/grid_aq_3_PF.dbf'/>
                <composite_data value='shapefiles/grid_aq_3_PF.prj'/>
            </param>
            <param name ='output_file_format' value='shp,pdf,png,jpeg,tiff,bmp'/>
            <param name ='proj' value='laea'/>
            <param name ='ellps' value='WGS84'/>
            <param name ='lat_0' value='-50'/>
            <param name ='lon_0' value='70'/>
            <param name ='x_0' value='0'/>
            <param name ='y_0' value='0'/>
            <param name ='units' value='m'/>
            <output file='results/PDF_output.pdf' name='PDF_output'>
                <assert_contents>
            	    <has_size value="26257" delta="0"/>
            	</assert_contents>
            </output>
            <output file='results/PNG_output.png' name='png_output'>
                <assert_contents>
            	    <has_size value="54459" delta="0"/>
            	</assert_contents>
            </output>
            <output file='results/JPEG_output.jpg' name='jpeg_output'>
                <assert_contents>
            	    <has_size value="47450" delta="0"/>
            	</assert_contents>
            </output>
            <output file='results/TIFF_output.tiff' name='tiff_output'>
                <assert_contents>
            	    <has_size value="691360" delta="0"/>
            	</assert_contents>
            </output>
            <output file='results/BMP_output.bmp' name='bmp_output'>
                <assert_contents>
            	    <has_size value="231478" delta="0"/>
            	</assert_contents>
            </output>
            <output file='results/Shapefile_dataset_shp.html' name='shapefile' compare='sim_size' delta="0">
                <extra_files type='file' name='shapefile.shp' value='results/shapefile.shp' compare='sim_size' delta="0"/>
                <extra_files type='file' name='shapefile.shx' value='results/shapefile.shx' compare='sim_size' delta="0"/>
                <extra_files type='file' name='shapefile.dbf' value='results/shapefile.dbf' compare='sim_size' delta="0"/>
                <extra_files type='file' name='shapefile.prj' value='results/shapefile.prj' compare='sim_size' delta="0"/>
            </output>
        </test>
    </tests>
    <help><![CDATA[
.. class:: infomark

**What it does ?**

This tool convert coordinates reference system of shapefiles (shp) for geospatial analysis. 
Multiples CRS are available for conversion, if you are looking to convert your sapefile in a non-available CRS, feel free to open an issue on the Galaxy Ecology GitHub : https://github.com/galaxyecology/tools-ecology/issues

.. class:: infomark

**Input**

This tool only takes shapefiles(shp) as input, if you need to convert a csv file to a shp file to use this tool, make sure to preserve the coordinates reference system of your file.

.. class:: infomark

**Output**

This tool provides multiples possible outputs, mainly shapefiles, pdf and tiff.

    ]]></help>
    <citations>
        <citation type='doi'>
            10.5281/zenodo.5884394
        </citation>
        <citation type='doi'>
            10.1201/9780429459016
        </citation>
        <citation type='doi'>
             10.32614/RJ-2018-009
        </citation>
    </citations>
</tool>
